---
import type { SiteLang } from '../../consts';
import {
  HeroSection,
  RichTextSection,
  MediaSection,
  MediaTextSection,
  ToolEmbedSection,
  GameEmbedSection,
  LinkListSection,
  CardGridSection,
  CalloutSection,
  DividerSection
} from './index';

interface SectionBackground {
  type?: 'none' | 'solid' | 'image';
  color?: string;
  imageSrc?: string;
}

interface SectionSettings {
  width?: 'container' | 'full';
  align?: 'left' | 'center';
  spacing?: 'compact' | 'normal' | 'loose';
  bg?: SectionBackground;
}

interface BuilderSection {
  id?: string;
  type: string;
  settings?: SectionSettings;
  [key: string]: unknown;
}

interface Props {
  sections?: BuilderSection[];
  lang: SiteLang;
  pageTitle: string;
}

const { sections = [], pageTitle } = Astro.props;

const withDefaults = (settings?: SectionSettings) => ({
  width: settings?.width ?? 'container',
  align: settings?.align ?? 'left',
  spacing: settings?.spacing ?? 'normal',
  bg: {
    type: settings?.bg?.type ?? 'none',
    color: settings?.bg?.color,
    imageSrc: settings?.bg?.imageSrc
  }
});

const sectionStyle = (bg: SectionBackground): string | undefined => {
  if (!bg || bg.type === 'none') return undefined;
  if (bg.type === 'solid' && bg.color) return `--section-bg:${bg.color};`;
  if (bg.type === 'image' && bg.imageSrc) return `--section-bg-image:url('${bg.imageSrc}');`;
  return undefined;
};
---
<div class="page-builder">
  {
    sections.map((section) => {
      const settings = withDefaults(section.settings);
      const style = sectionStyle(settings.bg);
      const widthClass = settings.width === 'full' ? 'builder-width-full' : 'builder-width-container';
      const alignClass = settings.align === 'center' ? 'builder-align-center' : 'builder-align-left';
      const spacingClass =
        settings.spacing === 'compact'
          ? 'builder-spacing-compact'
          : settings.spacing === 'loose'
            ? 'builder-spacing-loose'
            : 'builder-spacing-normal';

      const backgroundClass =
        settings.bg.type === 'solid'
          ? 'builder-bg-solid'
          : settings.bg.type === 'image'
            ? 'builder-bg-image'
            : 'builder-bg-none';

      const sectionNode = (
        <div class={`builder-section__inner ${alignClass}`}>
          {section.type === 'Hero' && <HeroSection {...section} pageTitle={pageTitle} />}
          {section.type === 'RichText' && <RichTextSection {...section} />}
          {section.type === 'Media' && <MediaSection {...section} />}
          {section.type === 'MediaText' && <MediaTextSection {...section} />}
          {section.type === 'ToolEmbed' && <ToolEmbedSection {...section} />}
          {section.type === 'GameEmbed' && <GameEmbedSection {...section} />}
          {section.type === 'LinkList' && <LinkListSection {...section} />}
          {section.type === 'CardGrid' && <CardGridSection {...section} />}
          {section.type === 'Callout' && <CalloutSection {...section} />}
          {section.type === 'Divider' && <DividerSection {...section} />}
        </div>
      );

      return (
        <section
          id={section.id}
          class={`builder-section ${widthClass} ${spacingClass} ${backgroundClass}`}
          style={style}
          data-section-type={section.type}
        >
          {settings.width === 'container' ? <div class="container">{sectionNode}</div> : sectionNode}
        </section>
      );
    })
  }
</div>
