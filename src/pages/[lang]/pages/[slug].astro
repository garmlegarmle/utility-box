---
import { getCollection, render } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import SectionRenderer from '../../../components/sections/SectionRenderer.astro';
import { LANGS, type SiteLang } from '../../../consts';
import { buildCollectionPath, buildLangHomePath, getEntryBySlug, getPairedEntry } from '../../../lib/content';
import { mdxComponents } from '../../../components/mdx';

export async function getStaticPaths() {
  const entries = await getCollection('pages');
  return entries.map((entry) => ({
    params: {
      lang: entry.data.lang,
      slug: entry.data.slug
    }
  }));
}

const lang = Astro.params.lang as SiteLang;
const slug = Astro.params.slug as string;

if (!LANGS.includes(lang) || !slug) {
  throw new Error('Invalid route params');
}

const entry = await getEntryBySlug('pages', lang, slug);
if (!entry) {
  throw new Error('Entry not found');
}

const paired = await getPairedEntry('pages', entry);
const otherLang: SiteLang = lang === 'en' ? 'ko' : 'en';
const languageToggleHref = paired
  ? buildCollectionPath(otherLang, 'pages', paired.data.slug)
  : buildLangHomePath(otherLang);

const alternates = paired
  ? [
      { lang, href: buildCollectionPath(lang, 'pages', entry.data.slug) },
      { lang: otherLang, href: buildCollectionPath(otherLang, 'pages', paired.data.slug) }
    ]
  : [
      { lang, href: buildCollectionPath(lang, 'pages', entry.data.slug) },
      { lang: otherLang, href: buildLangHomePath(otherLang) }
    ];

const hasSections = (entry.data.sections ?? []).length > 0;
let Content: ((props: { components: Record<string, unknown> }) => unknown) | null = null;

if (!hasSections) {
  const rendered = await render(entry);
  Content = rendered.Content;
}

const pageBg = entry.data.pageBg ?? { type: 'none' };
const pageBackgroundStyle =
  pageBg.type === 'solid' && pageBg.color
    ? `--page-bg:${pageBg.color};`
    : pageBg.type === 'image' && pageBg.imageSrc
      ? `--page-bg-image:url('${pageBg.imageSrc}');`
      : undefined;

const pageBackgroundClass =
  pageBg.type === 'solid' ? 'page-bg-solid' : pageBg.type === 'image' ? 'page-bg-image' : 'page-bg-none';
---
<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  lang={lang}
  languageToggleHref={languageToggleHref}
  canonicalPath={buildCollectionPath(lang, 'pages', entry.data.slug)}
  alternates={alternates}
>
  <article class={`section page-builder-surface ${pageBackgroundClass}`} style={pageBackgroundStyle}>
    <div class="container">
      <header class="page-head">
        <h1>{entry.data.title}</h1>
        <p>{entry.data.description}</p>
      </header>
    </div>

    {hasSections ? (
      <SectionRenderer sections={entry.data.sections} lang={lang} pageTitle={entry.data.title} />
    ) : (
      <div class="container">
        {entry.data.heroImage && (
          <figure class="hero-image">
            <img src={entry.data.heroImage} alt={entry.data.title} loading="lazy" decoding="async" />
          </figure>
        )}

        <div class="content-surface content-prose">{Content && <Content components={mdxComponents} />}</div>
      </div>
    )}
  </article>
</BaseLayout>
