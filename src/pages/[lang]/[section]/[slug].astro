---
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { LANGS, type SiteLang } from '../../../consts';
import {
  SECTION_COLLECTIONS,
  type SectionKey,
  buildCollectionPath,
  buildLangHomePath,
  formatDate,
  getEntryBySlug,
  getPairedEntry
} from '../../../lib/content';
import { mdxComponents } from '../../../components/mdx';

export async function getStaticPaths() {
  const paths = [];

  for (const section of SECTION_COLLECTIONS) {
    const entries = await getCollection(section);
    entries.forEach((entry) => {
      paths.push({
        params: {
          lang: entry.data.lang,
          section,
          slug: entry.data.slug
        }
      });
    });
  }

  return paths;
}

const lang = Astro.params.lang as SiteLang;
const section = Astro.params.section as SectionKey;
const slug = Astro.params.slug as string;

if (!LANGS.includes(lang) || !SECTION_COLLECTIONS.includes(section) || !slug) {
  throw new Error('Invalid route params');
}

const entry = await getEntryBySlug(section, lang, slug);
if (!entry) {
  throw new Error('Entry not found');
}

const paired = await getPairedEntry(section, entry);
const otherLang: SiteLang = lang === 'en' ? 'ko' : 'en';
const locale = lang === 'ko' ? 'ko-KR' : 'en-US';

const langToggleHref = paired
  ? buildCollectionPath(otherLang, section, paired.data.slug)
  : buildLangHomePath(otherLang);

const alternates = paired
  ? [
      { lang, href: buildCollectionPath(lang, section, entry.data.slug) },
      { lang: otherLang, href: buildCollectionPath(otherLang, section, paired.data.slug) }
    ]
  : [
      { lang, href: buildCollectionPath(lang, section, entry.data.slug) },
      { lang: otherLang, href: buildLangHomePath(otherLang) }
    ];

const { Content } = await entry.render();

const metaItems = [
  entry.data.date ? formatDate(entry.data.date, locale) : '',
  entry.data.category ?? '',
  ...(entry.data.tags ?? []).map((tag) => `#${tag}`)
].filter(Boolean);

const sectionTitle =
  lang === 'ko'
    ? section === 'blog'
      ? '블로그'
      : section === 'tools'
        ? '도구'
        : '게임'
    : section[0].toUpperCase() + section.slice(1);
---
<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  lang={lang}
  activeNav={section}
  languageToggleHref={langToggleHref}
  canonicalPath={buildCollectionPath(lang, section, entry.data.slug)}
  alternates={alternates}
>
  <article class="section">
    <div class="container">
      <header class="page-head">
        <h1>{entry.data.title}</h1>
        <p>{entry.data.description}</p>
        <p class="meta-row">
          <span>{sectionTitle}</span>
          {metaItems.map((item) => <span>• {item}</span>)}
        </p>
      </header>

      {entry.data.heroImage && (
        <figure class="hero-image">
          <img src={entry.data.heroImage} alt={entry.data.title} loading="lazy" decoding="async" />
        </figure>
      )}

      <div class="content-surface content-prose">
        <Content components={mdxComponents} />
      </div>

      <div class="lang-bar">
        <a class="text-link" href={`/${lang}/${section}/`}>
          {lang === 'ko' ? `${sectionTitle} 목록으로` : `Back to ${sectionTitle}`} →
        </a>
      </div>
    </div>
  </article>
</BaseLayout>
