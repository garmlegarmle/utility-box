---
import { getCollection, render } from 'astro:content';
import { mdxComponents } from '../../../components/mdx';
import { LANGS } from '../../../consts';
import DetailLayout from '../../../layouts/DetailLayout.astro';
import { buildCollectionPath, buildSectionPath, getEntryBySlug, getOtherLang, getPairedEntry, isSupportedLang } from '../../../lib/content';

export async function getStaticPaths() {
  const entries = await getCollection('tools');
  return entries.map((entry) => ({
    params: {
      lang: entry.data.lang,
      slug: entry.data.slug
    }
  }));
}

const lang = Astro.params.lang as string;
const slug = Astro.params.slug as string;

if (!isSupportedLang(lang) || !slug || !LANGS.includes(lang)) {
  throw new Error('Invalid route params');
}

const entry = await getEntryBySlug('tools', lang, slug);
if (!entry) {
  throw new Error('Entry not found');
}

const paired = await getPairedEntry('tools', entry);
const otherLang = getOtherLang(lang);
const { Content } = await render(entry);

const languageToggleHref = paired
  ? buildCollectionPath(otherLang, 'tools', paired.data.slug)
  : buildSectionPath(otherLang, 'tools');

const alternates = paired
  ? [
      { lang, href: buildCollectionPath(lang, 'tools', entry.data.slug) },
      { lang: otherLang, href: buildCollectionPath(otherLang, 'tools', paired.data.slug) }
    ]
  : [
      { lang, href: buildCollectionPath(lang, 'tools', entry.data.slug) },
      { lang: otherLang, href: buildSectionPath(otherLang, 'tools') }
    ];

const leadTag = entry.data.tags?.[0] ?? entry.data.category ?? 'tag';
const programSrc = entry.data.heroImage ?? entry.data.image ?? entry.data.cardImage;
---
<DetailLayout
  lang={lang}
  title={entry.data.title}
  description={entry.data.description}
  canonicalPath={buildCollectionPath(lang, 'tools', entry.data.slug)}
  languageToggleHref={languageToggleHref}
  alternates={alternates}
  leadTag={leadTag}
  showProgramSlot={true}
  programSrc={programSrc}
  programAlt={entry.data.title}
  activeNav="tools"
>
  <Content components={mdxComponents} />
</DetailLayout>
